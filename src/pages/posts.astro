---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const [systems, lessons, concepts, people, companies, timelines] = await Promise.all([
  getCollection('systems'),
  getCollection('lessons'),
  getCollection('concepts'),
  getCollection('people'),
  getCollection('companies'),
  getCollection('timelines'),
]);

function getDate(entry: any, type: string) {
  if (type === 'systems') return entry.data.release_date || '';
  if (type === 'lessons') return entry.data.date || entry.data.phase || '';
  if (type === 'concepts') return entry.data.date || '';
  if (type === 'people') return entry.data.date || '';
  if (type === 'companies') return entry.data.date || '';
  if (type === 'timelines') return entry.data.date || '';
  return '';
}

function getTitleOrName(data: any) {
  return data.title || data.name || '(Untitled)';
}

const allPosts = [
  ...systems.map(e => ({...e, _type: 'System', _date: getDate(e, 'systems'), _url: `/systems/${e.slug}`, _excerpt: e.data.summary })),
  ...lessons.map(e => {
    const [system, phase, ...slugParts] = e.slug.split('/');
    return {
      ...e,
      _type: 'Lesson',
      _date: getDate(e, 'lessons'),
      _url: `/lessons/${system}/${phase}/${slugParts.join('/')}`,
      _excerpt: e.data.summary
    };
  }),
  ...concepts.map(e => ({...e, _type: 'Concept', _date: getDate(e, 'concepts'), _url: `/concepts/${e.slug}`, _excerpt: e.data.summary })),
  ...people.map(e => ({...e, _type: 'Person', _date: getDate(e, 'people'), _url: `/people/${e.slug}`, _excerpt: e.data.bio })),
  ...companies.map(e => ({...e, _type: 'Company', _date: getDate(e, 'companies'), _url: `/companies/${e.slug}`, _excerpt: e.data.summary })),
];

allPosts.sort((a, b) => String(b._date).localeCompare(String(a._date)));
---

<Layout>
  <main>
    <header>
      <h1>All Posts</h1>
    </header>
    <ul>
      {allPosts.map(post => (
        <li style="margin-bottom: 1.5em;">
          <a href={post._url}><strong>{getTitleOrName(post.data)}</strong></a>
          <span style="margin-left: 0.5em; color: #888; font-size: 0.95em;">[{post._type}]</span>
          {post._date && <span style="margin-left: 0.5em; color: #aaa; font-size: 0.9em;">{post._date}</span>}
          {post._excerpt && <div style="margin-top: 0.3em; color: #444;">{post._excerpt}</div>}
        </li>
      ))}
    </ul>
  </main>
</Layout> 