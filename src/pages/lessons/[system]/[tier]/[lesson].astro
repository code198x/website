---
import LessonLayout from "../../../../layouts/LessonLayout.astro";
import { getEntry, getCollection, render } from "astro:content";

const { params } = Astro;
const { system, tier, lesson } = params;
const tierNumber = Number((tier as string).replace('tier-', ''));

const systemEntry = await getEntry("systems", system);
const systemName = systemEntry?.data.name ?? system;

const lessons = await getCollection("lessons");
const lessonEntry = lessons.find(
  (entry) =>
    entry.data.system === system &&
    `tier-${entry.data.tier}` === tier &&
    entry.slug === lesson
);

if (!lessonEntry) {
  throw new Error(`Lesson not found: ${system}/${tier}/${lesson}`);
}

const { Content } = await render(lessonEntry);

export async function getStaticPaths() {
  const lessons = await getCollection("lessons");
  return lessons.map((lesson: any) => ({
    params: {
      system: lesson.data.system,
      tier: `tier-${lesson.data.tier}`,
      lesson: lesson.slug,
    },
  }));
}
---

<LessonLayout
  title={lessonEntry.data.title}
  system={system}
  systemName={systemName}
  tierNumber={tierNumber}
  summary={lessonEntry.data.summary}
>
  <Content />
</LessonLayout>